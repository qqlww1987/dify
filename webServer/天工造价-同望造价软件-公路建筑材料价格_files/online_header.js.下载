$(document).ready(function(){
	
	// 设置所在省份
	setLocation(); 
	
	//登录实现跳转到当前页面
	$("#loginLink").on("click",function(){
		var currentLink=location.href;
		var target="/base/index.jsp?target_url="+currentLink;
		$(this).attr("href",target);
		document.getElementById("loginLink").click();
		
	});
    
	if(screen.width<=1024) {
		$("a[href='/base/logout.sec']").hide();
		var a = "<a href='/base/logout.sec'>退出</a>";
		$($(".bd0")[0]).append(a);
	} else {
		$("a[href='/base/logout.sec']").show();
	}	
	
    loginInOperation([showUserInfo,countUnreadMessages,checkMemberState]);
   
	
	 //用户名悬停效果  
	/* $('.user-name').hover(function(){
		$(this).children('.id-card').show();
		$(this).addClass('user-name-1');
	},function(){
		$('.id-card').hide();
		$(this).removeClass('user-name-1');
	});*/

    //搜索标签切换
	/*$(".searchType li").click(function(e){
		var url="";
		$(this).addClass("on").siblings("li").removeClass("on");
        var searchType=$(this).text();
		if(searchType=='信息价'){
			$("#searchWord").attr("placeholder","请输入产品名称、类别、规格型号等关键词 ，如“碎石 2cm”");
			url="/price/gov/search.html";
			$("#searchWord").attr("name","searchWord");
			$("#html4placeholder").html("请输入产品名称、类别、规格型号等关键词 ，如“碎石 2cm”");
			if(hotSearch != null) {
				var priceHotSearch = hotSearch.信息价;
				if (priceHotSearch != null && priceHotSearch.length > 0) {
					var appendHtml = "";
					for(var i = 0; i < priceHotSearch.length; i++) {
						appendHtml += "<a class=\"hotSearchKey\" href=\"#\">"+priceHotSearch[i]+"</a>";
					}
					$("#hotSearch .hotSearchKey").remove();
					$("#hotSearch .fc9").after(appendHtml);
				}
			}
		}else if(searchType=='市场价'){
			$("#searchWord").attr("placeholder","请输入产品名称、类别、规格型号等关键词 ，如“碎石 2cm”");
			url="/price/product/search/publicSearch.html";
			$("#searchWord").attr("name","searchWord");
			$("#html4placeholder").html("请输入产品名称、类别、规格型号等关键词 ，如“碎石 2cm”");
			if(hotSearch != null) {
				var priceHotSearch = hotSearch.市场价;
				if (priceHotSearch != null && priceHotSearch.length > 0) {
					var appendHtml = "";
					for(var i = 0; i < priceHotSearch.length; i++) {
						appendHtml += "<a class=\"hotSearchKey\" href=\"#\">"+priceHotSearch[i]+"</a>";
					}
					$("#hotSearch .hotSearchKey").remove();
					$("#hotSearch .fc9").after(appendHtml);
				}
			}
		}else if(searchType=='钢材库'){
			$("#searchWord").attr("placeholder","请输入产品名称、类别、规格型号等关键词 ，如“不锈钢”");
			url="/price/tgGangCai/product/search/index-1.html";
			$("#searchWord").attr("name","key");
			$("#html4placeholder").html("请输入产品名称、类别、规格型号等关键词 ，如“不锈钢”");
			if(hotSearch != null) {
				var priceHotSearch = hotSearch.钢材库;
				if (priceHotSearch != null && priceHotSearch.length > 0) {
					var appendHtml = "";
					for(var i = 0; i < priceHotSearch.length; i++) {
						appendHtml += "<a class=\"hotSearchKey\" href=\"#\">"+priceHotSearch[i]+"</a>";
					}
					$("#hotSearch .hotSearchKey").remove();
					$("#hotSearch .fc9").after(appendHtml);
				}
			}
		}else if(searchType=='标准定额'){
			$("#searchWord").attr("placeholder","请输入定额子目名称");
			url="/ecSql/site/dek/de/query.html";
			$("#searchWord").attr("name","searchWord");
			$("#html4placeholder").html("请输入定额子目名称");
			if(hotSearch != null) {
				var priceHotSearch = hotSearch.定额;
				if (priceHotSearch != null && priceHotSearch.length > 0) {
					var appendHtml = "";
					for(var i = 0; i < priceHotSearch.length; i++) {
						appendHtml += "<a class=\"hotSearchKey\" href=\"#\">"+priceHotSearch[i]+"</a>";
					}
					$("#hotSearch .hotSearchKey").remove();
					$("#hotSearch .fc9").after(appendHtml);
				}			
			}
		}else if(searchType=='文库'){
			$("#searchWord").attr("placeholder","请输入文档名称");		
			url="/shareData/site/document/search.html";
			$("#searchWord").attr("name","searchWord");
			$("#html4placeholder").html("请输入文档名称");
			if(hotSearch != null) {
				var priceHotSearch = hotSearch.文库;
				if (priceHotSearch != null && priceHotSearch.length > 0) {
					var appendHtml = "";
					for(var i = 0; i < priceHotSearch.length; i++) {
						appendHtml += "<a class=\"hotSearchKey\" href=\"#\">"+priceHotSearch[i]+"</a>";
					}
					$("#hotSearch .hotSearchKey").remove();
					$("#hotSearch .fc9").after(appendHtml);
				}
			}
		}else if(searchType=='供应商'){
			$("#searchWord").attr("placeholder","请输入厂商名称");
			url="/supplier/productPrice/supplier/search/index-1.html";
			$("#searchWord").attr("name","key");
			$("#html4placeholder").html("请输入厂商名称");
		}else if(searchType=='项目指标'){
			$("#searchWord").attr("placeholder","请输入指标名称,如 “T梁 桥”");
			url="/myFiles/myEcCostFile/site/calculate/billZb/publicSearch.html";
			$("#searchWord").attr("name","name");
			$("#html4placeholder").html("请输入指标名称,如 “T梁 桥”");
			if(hotSearch != null) {
				var priceHotSearch = hotSearch.指标;
				if (priceHotSearch != null && priceHotSearch.length > 0) {
					var appendHtml = "";
					for(var i = 0; i < priceHotSearch.length; i++) {
						appendHtml += "<a class=\"hotSearchKey\" href=\"#\">"+priceHotSearch[i]+"</a>";
					}
					$("#hotSearch .hotSearchKey").remove();
					$("#hotSearch .fc9").after(appendHtml);
				}
			}
		}else if(searchType=='预算价'){
			$("#searchWord").attr("placeholder","请输入工料机预算价名称，如“沥青”");
			url="/myFiles/myEcCostFile/site/calculate/gljZb/publicSearch.html";
			$("#searchWord").attr("name","name");
			$("#html4placeholder").html("请输入工料机预算价名称，如“沥青”");
		}
		$("#headSearchForm").attr("action",url);  
		$(".searchWordTxt").html(searchType);
	});*/


       
   

    //顶部搜索栏选中状态
    var url=window.location.href;

    //价格信息的二级菜单选中状态
	$(".mlevel2 li>a").each(function(){
	      if(url.indexOf($(this).data("menukey"))!=-1){
	    	  $(this).parents(".m").siblings().removeClass("active");
		      $(this).parents(".m").addClass("active");
	    }
	});
	
	$(".mlevel2").each(function(){
		var parentWidth=$(this).parents("li").width();
		$(this).css("width",(parentWidth-20)+"px");
	});
	
 
   
  /* $("#header_indexCate  li").mouseover(function(){
	   $(this).find(".lev2").show();
	   $(this).siblings().find(".lev2").hide();
   })
   
   $("#header_indexCate .fa-close").on("click",function(){
	   $("#header_indexCate").slideUp();
   });*/
	
	

   //返回顶部 只有首页才显示定额、专业文库、软件应用的链接
  /* if(url.indexOf("/home/index.html")!=-1){
        $(".hideLink").css("display","block");   		
   }*/

   //菜单选中状态  
   var menuCode=$("body").data("menucode");
   $(".antlinemenu>li>a").each(function(){
      if(menuCode&&$(this).data("menucode")==menuCode){
         $(this).parent().siblings().removeClass("active");
	     $(this).parent().addClass("active");
	  }
    });
   
   //除了首页，其他页面鼠标移到材料分类处，出现下拉选择材料分类
   if("home"!=menuCode){
	   $(".li-caiLiao").hover(function(){
		   $(".indexCatePage").slideDown(); 
	   },function(){});
   }
   
   $(".indexCatePage").on("mouseleave",function(){ $(this).hide() });
   
   $(".indexCatePage .indexCate>li").mouseenter(function(){
   	var widths=[];
   	$(this).find(".lev2_title").each(function(){
   		widths.push($(this).width());
   	});
   	var maxWidth=Math.max.apply(Math,widths);
   	$(this).find(".lev2_title").width(maxWidth+"px");
   	
        console.log($(this).find(".lev2_title").length);
   });


    //切换城市
	$(".areaBox .areaLi a").click(function(){	
		var provinceName=$(this).text();	
		var _url= "/home/setProvince.json";
		 $.ajax({
				url : _url,
				type : 'post',
				data:{provinceName:provinceName},
				dataType : 'json',
				timeout : 5000,
				async : true, //异步
				success : function(data) {
					if(data&&data.success){
						var win_location = window.location+"";					
						if(win_location.substr(win_location.length-1,1)=='#'){
							win_location = win_location.substr(0,win_location.length-1);
						}
						if(win_location.indexOf("changeArea=top")==-1){
							if(win_location.indexOf("?")>-1){
								win_location += "&changeArea=top";
							}else{
								win_location += "?changeArea=top";
							}
						}
						window.location.assign(win_location);			
					}else{
						alert(data.msg);
					}								
				},
				error:function(){
					
				}		
			});	
	});
    
	// 特殊符号及删除键
    $(".sCodeList li a").each(function(){
    	$(this).click(function() {
            var obj =  $(this).html();
            var input=$(this).parents(".searchTab").find(".sInput");
			insertAtCursor(input[0],obj);
			input.focus();
        });
    });
    
    
    $(".searchTab .sInput").keyup(function() {
        if ($(this).val().length > 0) {
        	$(".searchTab .clean_input").show();
        } else {
        	$(".searchTab .clean_input").hide();
        }
    });
    $(".searchTab .sInput").focus(function() {
        if ($(this).val().length > 0) {
        	$(".searchTab .clean_input").show();
        } else {
        	$(".searchTab .clean_input").hide();
        }
    });
    $(".searchTab .clean_input").click(function() {
    	   $(".searchTab .sInput").val("").focus();
    	   $(this).hide();
    });

    $(".btmAD").delay('3000').slideToggle().siblings('.btmAD_s').delay('3500').slideToggle(); // 广告关闭
    
    //双11广告
	/*$('body').append(
			"<a style=\"position: fixed; right:5px; bottom: 100px; width: 160px; height:215px; text-align: center; " +
			"color: #f60; box-shadow: 0 0 5px rgba(0,0,0,.5); padding: 0; " +
			"background:#125b64 url(\/base\/skin\/images\/youhui.jpg) no-repeat center top;\" " +
			"href=\"http:\/\/www.tgcost.com\/base\/order\/createOrder.html?goodsCode=qyhy\">" +
			"<\/a>"
	);*/
    
    $(".searchBar").slide(); //顶部搜索
    
    // 关闭右侧导航
	$(".rNavs-close .fa").on("click",function(){ $(".rNavs").fadeOut() });
	

})


function checkMemberState(){
    //会员即将过期提醒以及频繁登录提醒
	if(document.cookie.match(new RegExp("(^| )ImminentExpiry=([^;]*)(;|$)")) == null || document.cookie.match(new RegExp("(^| )LoginWarning=([^;]*)(;|$)")) == null || document.cookie.match(new RegExp("(^| )AuthorizePrompt=([^;]*)(;|$)")) == null ){
		var expiry = new Date(new Date().getTime() + (12 * 60 * 60 * 1000));
		$.ajax({
			type: "post",
	        url: "/base/user/myServer.json",
	        dataType: "json",
	        timeout: 5000, //超时时间：5秒
	        async:true,
	       	success: function (data) {
	       		if(data.success){
	       			var name = data.item.userName;
	       			var photo = data.item.userPhoto;
	       			var qq = data.item.userQQ;
	       			if(data.item.type == 'ImminentExpiry' && document.cookie.match(new RegExp("(^| )ImminentExpiry=([^;]*)(;|$)")) == null){
	       				document.cookie = ["ImminentExpiry", "=", escape("yes"), 
	       					               ";expires=", expiry.toGMTString(), 
	       							       ";path=/", 
	       								   ";domain=", ("")
	       								  ].join("");
	       				$('body').append(
	       						"<div id=\"popwin-ExpiryMember\" style=\"width: 100%;height: 100%;position: fixed;left: 0;top: 0px;z-index: 9999;background-color: rgba(0, 0, 0, 0.75);\">"+
	       						"<div style=\"height:auto;width: 520px;margin: auto;margin-top: 10%;border: solid 1px #0094e1;box-shadow: 0 0 10px #000;position: relative;z-index: 9999;background: #fff;\">"+
	       							"<div>"+
	       								"<a id=\"closePopwin1\" class=\"rotate-hover\" href=\"#\" style=\"float: right;display: block;margin: 5px 5px 0 0;padding: 0 8px 5px;line-height: 20px;font-size: 20px;cursor: pointer;color: #fff;\">x<\/a>"+
	       								"<h3 style=\"padding: 7px 0 7px 15px;color: #fff;border-bottom: 1px #ddd solid;background: #008BD6;font-size: 14px;margin-bottom: 20px;\">温馨提示<\/h3>"+
	       							"<\/div>"+
	       							"<div style=\"margin-top: -22px;height: 120px;text-align: center;font-size: 15px;padding: 20px;\">"+
	       								"<p>您的账号会员服务即将在<b style=\"color:#008BD6;font-weight:bold;\">"+data.item.ImminentExpiryNum+"天<\/b>后到期，为不影响您的使用，请及时续期<\/p>"+
	       								"<p>（企业会员权限：包含<span style=\"color:red;\">全国各省公路建筑<\/span>信息查阅<span style=\"color:red;\">下载<\/span>，及软件<span style=\"color:red;\">批量刷价，批量计算运杂费等<\/span>）<\/p>"+
	       								"<div style=\"margin-top: 20px;\">"+
	       									"<lable style=\"margin-left: 10px;\">专员名称：<b style=\"color:#008BD6;font-weight:bold;\">"+name+"<\/b><\/lable>"+  
	       									"<lable style=\"margin-left: 10px;\">电话：<b style=\"color:#008BD6;font-weight:bold;\">"+photo+"<\/b><\/lable>"+
	       									"<lable style=\"margin-left: 10px;\">QQ：<b style=\"color:#008BD6;font-weight:bold;\">"+qq+"<\/b><\/lable>"+
	       								"<\/div>"+
	       							"<\/div>"+
	       							"<div id=\"noExpiryDiv1\" style=\"float: right;margin-top: -22px;margin-right: 10px;cursor: pointer;\">"+
	       								"<input type=\"checkbox\" id=\"noExpiry\" style=\"cursor: pointer;\">"+ 
	       								"<label style=\"float: right;margin-top: -2px;cursor: pointer;\">不再提醒<\/label>"+
	       							"<\/div>"+
	       						"<\/div>"+
	       					"<\/div>"		
	       				)
	       			}else if(data.item.type == 'LoginWarning' && document.cookie.match(new RegExp("(^| )LoginWarning=([^;]*)(;|$)")) == null){
	       				document.cookie = ["LoginWarning", "=", escape("yes"), 
	       					               ";expires=", expiry.toGMTString(), 
	       							       ";path=/", 
	       								   ";domain=", ("")
	       								  ].join("");
	       				$('body').append(
	       						"<div id=\"popwin-WarningMember\" style=\"width: 100%;height: 100%;position: fixed;left: 0;top: 0px;z-index: 9999;background-color: rgba(0, 0, 0, 0.75);\">"+
	       						"<div style=\"height:auto;width: 520px;margin: auto;margin-top: 10%;border: solid 1px #0094e1;box-shadow: 0 0 10px #000;position: relative;z-index: 9999;background: #fff;\">"+
	       							"<div>"+
	       								"<a id=\"closePopwin2\" class=\"rotate-hover\" href=\"#\" style=\"float: right;display: block;margin: 5px 5px 0 0;padding: 0 8px 5px;line-height: 20px;font-size: 20px;cursor: pointer;color: #fff;\">x<\/a>"+
	       								"<h3 style=\"padding: 7px 0 7px 15px;color: #fff;border-bottom: 1px #ddd solid;background: #008BD6;font-size: 14px;margin-bottom: 20px;\">温馨提示<\/h3>"+
	       							"<\/div>"+
	       							"<div style=\"margin-top: -22px;height: 120px;text-align: center;font-size: 15px;font-weight: bold;padding: 20px;\">"+
	       								"<p>您的账号还未开通会员服务，为不影响您的使用，请<span style=\"color:red;\">申请试用<\/span>。<\/p>"+
	       								"<p>（企业会员权限：包含<span style=\"color:red;\">全国各省公路建筑<\/span>信息查阅<span style=\"color:red;\">下载<\/span>，及软件<span style=\"color:red;\">批量刷价，批量计算运杂费等<\/span>）<\/p>"+
	       								"<div style=\"margin-top: 20px;\">"+
	       									"<lable style=\"margin-left: 10px;\">专员名称：<b style=\"color:#008BD6;font-weight:bold;\">"+name+"<\/b>"+"<\/lable>"+  
	       									"<lable style=\"margin-left: 10px;\">电话：<b style=\"color:#008BD6;font-weight:bold;\">"+photo+"<\/b>"+"<\/lable>"+
	       									"<lable style=\"margin-left: 10px;\">QQ：<b style=\"color:#008BD6;font-weight:bold;\">"+qq+"<\/b>"+"<\/lable>"+
	       								"<\/div>"+
	       							"<\/div>"+
	       							"<div style=\"height: 50px;text-align: center;\">"+
	       								"<a href=\"http:\/\/www.tgcost.com\/base\/order\/createOrder.html?goodsCode=qyhy\" style=\"padding: 1em 3em;background-color: #008ad2;font-size: 14px;font-weight: bold;color: #fff;border-radius: 3px;cursor: pointer;transition-duration: .5s;\">申请试用<\/a>"+
	       							"<\/div>"+
	       							"<div id=\"noExpiryDiv2\" style=\"float: right;margin-top: -22px;margin-right: 10px;cursor: pointer;\">"+
	       								"<input type=\"checkbox\" id=\"noExpiry2\" style=\"cursor: pointer;\">"+ 
	       								"<label style=\"float: right;margin-top: -2px;cursor: pointer;\">不再提醒<\/label>"+
	       							"<\/div>"+
	       						"<\/div>"+
	       					"<\/div>"
	       				)
	       			}else if(data.item.type == 'AuthorizePrompt' && document.cookie.match(new RegExp("(^| )AuthorizePrompt=([^;]*)(;|$)")) == null){
	       				document.cookie = ["AuthorizePrompt", "=", escape("yes"), 
	       					               ";expires=", expiry.toGMTString(), 
	       							       ";path=/", 
	       								   ";domain=", ("")
	       								  ].join("");
	       				$("body").append(
	       						"<div id=\"popwin-AuthorizeMember\" style=\"width: 100%;height: 100%;position: fixed;left: 0;top: 0px;z-index: 9999;background-color: rgba(0, 0, 0, 0.75);\">"+
	       						"<div style=\"height:auto;width: 800px;margin: auto;margin-top: 10%;border: solid 1px #0094e1;box-shadow: 0 0 10px #000;position: relative;z-index: 9999;background: #fff;\">"+
	       							"<div>"+
	       								"<a id=\"closePopwin3\" class=\"rotate-hover\" href=\"#\" style=\"float: right;display: block;margin: 5px 5px 0 0;padding: 0 8px 5px;line-height: 20px;font-size: 20px;cursor: pointer;color: #fff;\">x<\/a>"+
	       								"<h3 style=\"padding: 7px 0 7px 15px;color: #fff;border-bottom: 1px #ddd solid;background: #008BD6;font-size: 14px;margin-bottom: 20px;\">温馨提示<\/h3>"+
	       							"<\/div>"+
	       							"<div style=\"margin-top: -22px;height: auto;text-align: center;font-size: 15px;font-weight: bold;padding: 20px;\">"+
	       								"<p>您的账号有以下服务尚未授权：<\/p>"+
	       								"<div style=\"margin-top: 10px;margin-bottom:10px\">"+
	       									"<table class=\"unauthorizedList\" style=\"color:#008BD6;font-weight:bold;\">" +
	       										"<tr style=\"font-size:15px;color:grey\">" +
	       											"<th style=\"font-size:15px;\">商品名称</th>"+
	       											"<th style=\"font-size:15px;\">操作</th>"+
	       										"</tr>"+
	       									"</table>"+
	       								"<\/div>"+
	       								"<p>为不影响您的使用，请点击首页右上角<span style=\"color:red;\">企业服务<\/span>或当前页面<span style=\"color:red;\">我要授权<\/span>进行授权。</p>"+
	       							"<\/div>"+
	       							"<div id=\"noExpiryDiv3\" style=\"float: right;margin-top: -22px;margin-right: 10px;cursor: pointer;\">"+
	       								"<input type=\"checkbox\" id=\"noExpiry3\" style=\"cursor: pointer;\">"+ 
	       								"<label style=\"float: right;margin-top: -2px;cursor: pointer;\">不再提醒<\/label>"+
	       							"<\/div>"+
	       						"<\/div>"+
	       					"<\/div>"
	       				);
	       				for(var i = 0; i < data.item.unauthorizedPermission.length; i++){
	       					var content = "<tr>" +
	       								  	"<td>"+data.item.unauthorizedPermission[i].productName+"</td>"+
	       								  	"<td><button class=\"btn btn-sm btn-primaryt toAu\" data-name=\""+data.item.unauthorizedPermission[i].productName+"\" data-corp=\""+data.item.unauthorizedPermission[i].corpId+"\" data-member=\""+data.item.unauthorizedPermission[i].memberId+"\">我要授权</button></td>"
	       								  "</tr>";
	       					$(".unauthorizedList").append(content);
	       				}
	       			}
	       		}
	       	}
		});
		
		
		$(document).on('click','.toAu',function(){
			var productName = $(this).data("name");
			var corpId = $(this).data("corp");
			var memberId = $(this).data("member");
			$.ajax({
				url:"/base/boss/productGoods/getCorpProductId.json?goodsName="+encodeURIComponent(productName),
				method:"POST",
				success:function(resp){
					if(resp.success){
						var url = encodeURI("/myFiles/user/client/myFiles/corp/grant/corpHomeIndex.html?corpId="+corpId+"&memberId="+memberId+"&productName="+resp.item.corpProductName);
						window.open(url);
					}
				},
				error:function(error){
					layer.msg('十分抱歉，服务器出错了！', {time: 1500,icon:2});
				}
			})
		});
		
		$(document).on('click',"#noExpiryDiv1",function(){
			$("#noExpiry1").prop("checked",true);
			$("#popwin-ExpiryMember").hide();
			$.ajax({
				type: "post",
		        url: "/base/user/notRemind.json",
		        dataType: "json",
		        async:false,
		        data:{
		        	"type":"expiry"
		        }
		    })
		});
		
		$(document).on('click',"#noExpiryDiv2",function(){
			$("#noExpiry2").prop("checked",true);
			$("#popwin-WarningMember").hide();
			$.ajax({
				type: "post",
		        url: "/base/user/notRemind.json",
		        dataType: "json",
		        async:false,
		        data:{
		        	"type":"warning"
		        }
		    })
		});
		$(document).on('click',"#noExpiryDiv3",function(){
			$("#noExpiry3").prop("checked",true);
			$("#popwin-AuthorizeMember").hide();
			$.ajax({
				type: "post",
		        url: "/base/user/notRemind.json",
		        dataType: "json",
		        async:false,
		        data:{
		        	"type":"authorize"
		        }
		    })
		});
		$(document).on('click',"#closePopwin1",function(){
			$("#popwin-ExpiryMember").hide();
		});
		$(document).on('click',"#closePopwin2",function(){
			$("#popwin-WarningMember").hide();
		});
		$(document).on('click',"#closePopwin3",function(){
			$("#popwin-AuthorizeMember").hide();
		});
	}
}

//add by majj 2015-08-24  头部“天工导航”下拉
/*$(".more-option").click(function(){
	if($(".more-option").hasClass("tri-up")){
		$(".tgoption").css("display","none")
		$(this).removeClass("tri-up");
	}
	else{
		$(".tgoption").css("display","block");
		$(this).addClass("tri-up");
	}
})
$(".tgoption").mouseover(function(){
	$(this).css("display","block");
	$(".more-option").addClass("tri-up");
})
$(".tgoption").mouseout(function(){
	$(this).css("display","none");
	$(".more-option").removeClass("tri-up");
})*/


function renderUserScore(){
	var a = Math.random(); 
	var url='/base/user/score/info.json'+'?rand='+a;
	$.ajax({
		url : url,
		type : 'get',
		dataType : 'json',
		timeout : 5000,
		async : true, //异步
		success : function(result) {
			if(result!=null){			   
                $("#score").text(result);		  
			}    										
		},
		error:function(){
			console.log("从tuc获取用户积分失败");
		}		
	});
}


function showUserInfo(){
	var a = Math.random(); 
	var url='/base/user/myInfo.json'+'?rand='+a;
	$.ajax({
		url : url,
		type : 'get',
		dataType : 'json',
		async : true, //异步
		success : function(data) {
			if(data!=null&&data.user!=null){
				$("#notLogin").css("display","none");
				
				$("#userName").html('<span class="ove iblock vam" style="width: 6em">'+(data.user.name||data.user.nickname||data.user.uid)+'</span><i class="fa fa-caret-down"></i>');
				$("#userEmail").text(data.user.email || data.user.uid);
				$("#userEmail").attr("title",data.user.email); 
				$("#score").text(data.user.score);
				//显示会员类型和到期时间
				if(data.userCategory == "内部员工"){
					$("#userCategoryShow").html(data.userCategory);
					$("#userCategoryShow").attr("title",data.userCategory); 
				}else{
					if(data.serviceEndTime != null && data.serviceEndTime != '' && new Date(Date.parse(data.serviceEndTime)) > new Date()){
						$("#userCategoryShow").html(data.userCategory);
						$("#userCategoryShow").attr("title",data.userCategory); 
					}else{
						$("#userCategoryShow").html("注册用户");
						$("#userCategoryShow").attr("title","注册用户"); 
					}
				}
				$(".headImg").css("height","225px");				
				if(data.userForm != null){
					var mobile = data.userForm.mobile == null ? "" : data.userForm.mobile;
					var qq = data.userForm.qq == null ? "" : data.userForm.qq;
					$("#userCategoryShow").after("<br>&nbsp;&nbsp;服务专员：<strong class='fc3' id='commissioner'>"+ data.userForm.name+"</strong>");
					$("#commissioner").after("<br>&nbsp;&nbsp;(加群秘，进专属省区群，享贴心服务)");
					$("#commissioner").after("<br>&nbsp;&nbsp;同望小群秘：<strong class='fc3'>13532265339</strong>");
					$("#commissioner").after("<br>&nbsp;&nbsp;专员QQ：<strong class='fc3'>"+ qq+"</strong>");
					$("#commissioner").after("<br>&nbsp;&nbsp;专员电话：<strong class='fc3'>"+ mobile +"</strong>");
				}else{
					$("#userCategoryShow").after("<br>&nbsp;&nbsp;服务专员：<strong class='fc3' id='commissioner'>服务人员</strong>");
					$("#commissioner").after("<br>&nbsp;&nbsp;(微信加群秘，进专属省区群，享贴心服务)");
					$("#commissioner").after("<br>&nbsp;&nbsp;同望小群秘：<strong class='fc3'>13532265339</strong>");
					$("#commissioner").after("<br>&nbsp;&nbsp;专员QQ：<strong class='fc3'>800008810</strong>");
					$("#commissioner").after("<br>&nbsp;&nbsp;专员电话：<strong class='fc3'>400-160-8860</strong>");
				}
				if(data.serviceEndTime != null && data.serviceEndTime != '') {
					$("#userCategoryShow").after("<br>&nbsp;&nbsp;会员到期：<strong class='fc3'>"+ data.serviceEndTime +"</strong>");
					$("#timeField").html(data.serviceBeginTime + "至" + data.serviceEndTime);
				}
				//$("#userCenter").attr("href","/member/inquiries/index.html");
				if(data.user.face==null || data.user.face=='null' || data.user.face==''){
					$("#face").attr("src","/home/skin/images/defaultFace.png");
					$("#face1").attr("src","/home/skin/images/defaultFace.png");
				}else{
					$("#face").attr("src",data.user.face);
					$("#face1").attr("src",data.user.face);
				}
				if(!data.isAdmin){
					$("#adminLink").remove();
				}
				renderUserScore();
				$("#login").show();
				
				if(!checkHeaderDatas(data)&&!checkAndBindShow(encodeURI(encodeURI(data.user.uid)))){
					location.href = "/base/common/bind.html?from=header";
				}
			}   
		},
		error:function(){
			alert("error!");
		}		
	});
}

/**
 * 绑定数据页面是否出现过
 * @returns {Boolean}
 */
function checkAndBindShow(account){
	 var c = getHeaderCookie("isBindShow" + account);
	 if(c!=null){
		 return true;
	 }
	 registerCookie("isBindShow" + account);
	 return false;
}

function checkIsBindShow(account){
	 var c = getHeaderCookie("isBindShow" + account);
	 if(c!=null){
		 return true;
	 }
	 return false;
}

function registerCookie(key) {
	 var d = new Date();
	  var currentTime = d.getTime();
	 d.setTime(currentTime+24*60*60*1000);
	 setHeaderCookie(key, "isBindShow", d);
}

function setHeaderCookie(key, value, expire){
	window.document.cookie = key + "=" + escape(value) + ((expire == null) ? ";path=/" : (";expires=" + expire.toGMTString() +";path=/"));
}

function getHeaderCookie(key){
	var search = key + "=";
	if (window.document.cookie.length > 0){
		offset = window.document.cookie.indexOf(search);
		if (offset != -1){ 
			offset += search.length;
			end = window.document.cookie.indexOf(";", offset)
			if (end == -1){
				end = window.document.cookie.length;
			}
			return unescape(window.document.cookie.substring(offset, end));
		}
	}
	return null;
}

function checkHeaderDatas(data){
	var qq = data.user.qq;
	var email = data.user.email;
	var phone = data.user.mobile;
	var workingLife = data.user.workingLife;
	var province = data.user.province;
	var city = data.user.city;
	if(!email||email==""||!checkHeaderEM(email)){
		return false;
	}
	if(!phone||phone==""||!checkHeaderPhone(phone)){
		return false;
	}
	if(!qq||qq==""){
		return false;
	}
	if(!workingLife||workingLife==""){
		return false;
	}
	if(!province||province==""){
		return false;
	}
	if(!city||city==""){
		return false;
	}
	return true;
	
}

/**
 * 检查手机号码
 * @returns {Boolean}
 */
function checkHeaderPhone(eVal) {
	if (eVal != '') {
		var reg = /^0?(13[0-9]|14[0-9]|15[0-9]|17[0-9]|18[0-9])[0-9]{4}[*]{4}$/;
		if (!reg.test(eVal)) {
			return false;
		}
	} else {
		return false;
	}
	return true;
}

/**检查邮箱格式**/
function checkHeaderEM(em) {
	return /^([a-z0-9][a-z0-9_\-\.]*)@([a-z0-9][a-z0-9\.\-]{0,20})\.([a-z]{2,4})$/i.test(em);
}


/** 所在城市设置服务端 cookie add by zhuwp 2015-06-11 */
function setLocation(){
	var _province = getLocation("cookie_province", "desc");
	if(_province == null){
		_province="广东";
	} else
		_province = decodeURIComponent(_province).replace(/\"/g,"");;
	$("#areaTit").html(_province);
}


// 获取用户未读消息数
function countUnreadMessages() {
	$.ajax({
		timeout : 4000,
		async : true,
		cache : false,
		type : "GET",
		url : "/member/messages/countUnreadMessages.json",
		dateType : "JSON",
		success : function(data) {
			if (eval("(" + data + ")") > 0) {
				$(".new-message-btn").show();
				$(".new-message-num").html(data);
				$(".new-message").show();
			}
		}
	});
}


function alertMessage(content){	
	layer.alert(content,{
		  icon: 0,title:"操作提示",shadeClose:true 
	});
}


function checkInputValue(){
	var tab=$(".topbd").children(":visible");
	
    var searchWord = tab.find(".sInput").val();
    tab.find(".sInput").val($.trim(searchWord)); // 去除搜索关键字前后空格
    searchWord = tab.find(".sInput").val();
    if (searchWord == '') {
	return false;
    }
    saveSearchWord(searchWord, "TGCOST");

    var searchArea = $("#areaTit").text();
    var detailType = $(".searchType").find(".on").text();
    saveSearchWordHistory(searchWord, "TGCOST", searchArea, detailType);

    return true;
}

function saveSearchWord(keyWord, type) {
    $.ajax({
        timeout	: 5000,
        async	: true, 
        cache	: false,
        type	: 'POST',
        url	: "/base/common/searchKey/save.json",
        dataType: 'json',
        data	: {
            keyWord : keyWord,
            type : type
        }
    });
}

function saveSearchWordHistory(keyWord, type, searchArea, detailType) {
    $.ajax({
        timeout	: 5000,
        async	: true, 
        cache	: false,
        type	: 'POST',
        url	: "/base/common/searchKeyHistory/save.json",
        dataType: 'json',
        data	: {
            keyWord : keyWord,
            type : type,
			searchArea : searchArea,
			detailType : detailType
        }
    });
}

// 特殊符号设置
function insertAtCursor(myField, myValue) {
    //IE support 
    if (document.selection) {
        myField.focus();
        sel = document.selection.createRange();
        sel.text = myValue;
        sel.select();
    }
    //MOZILLA/NETSCAPE support 
    else if (myField.selectionStart || myField.selectionStart == '0') {
        var startPos = myField.selectionStart;
        var endPos = myField.selectionEnd;
        // save scrollTop before insert 
        var restoreTop = myField.scrollTop;
        myField.value = myField.value.substring(0, startPos) + myValue + myField.value.substring(endPos, myField.value.length);
        if (restoreTop > 0) {
            // restore previous scrollTop 
            myField.scrollTop = restoreTop;
        }
        myField.focus();
        myField.selectionStart = startPos + myValue.length;
        myField.selectionEnd = startPos + myValue.length;
    } else {
        myField.value += myValue;
        myField.focus();
    }
}


function doCheckKickout(){
	$.ajax({
	  	type: "post",
	  	url: "/base/user/isLogin.json",
	  	async: true,
	  	success: function(json){
	  		if(!json.success)
	  			return;
	  		
			//检测被踢
			$.ajax({
			   type: "GET",
			   url: "/base/user/getKickoutEnabled.json",
			   dataType: "JSON",
			   success: function(json1){	 
				  if("true"!=json1 && true!=json1)
					  return;
				  
				  var timer1 = setInterval(function(){
					  $.ajax({
					  	type: "GET",
					   	url: "/base/user/getKickoutInfo.json",
					   	dataType: "JSON",
					   	success: function(json2){
					   		//$("title").text("t:"+json2);
						   if(!!json2){
							   clearInterval(timer1);
							   alert("您的账号已在其它主机或浏览器上登录, 请刷新当前页面");	
							   //location.href = location.href;
						   }
					   	}
					  })
				  }, 20000);
				}
			});
	  	}	
	});
}